# Домашняя работа 13-1 Контейнеры, поды, deployment, statefulset, services, endpoints

## Подготовительная часть.

Для использования собственных образов будет использоваться регистри в корпоративном ГитЛабе.
ГитЛаб в частной сети без доступа из вне.

# Доступ к Гит

1. Создание токена

       токен ejs7zH8qm8moyVU5X5c3

        oleg@mck-devops-tools:~/kubespray$ sudo docker login  gitreg.migcredit.ru -u ORovenskij -p ejs7zH8qm8moyVU5X5c3
        WARNING! Using --password via the CLI is insecure. Use --password-stdin.
        WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
        Configure a credential helper to remove this warning. See
        https://docs.docker.com/engine/reference/commandline/login/#credentials-store

        Login Succeeded
        oleg@mck-devops-tools:~/kubespray$

2. Клонирование учебного репозитория

            oleg@mck-devops-tools:~$ git clone https://github.com/olegrovenskiy/devkub-homeworks.git
            Cloning into 'devkub-homeworks'...
            remote: Enumerating objects: 356, done.
            remote: Counting objects: 100% (356/356), done.
            remote: Compressing objects: 100% (323/323), done.
            remote: Total 356 (delta 165), reused 86 (delta 18), pack-reused 0
            Receiving objects: 100% (356/356), 223.44 KiB | 2.13 MiB/s, done.
            Resolving deltas: 100% (165/165), done.
            oleg@mck-devops-tools:~$
            oleg@mck-devops-tools:~$
            oleg@mck-devops-tools:~$
            oleg@mck-devops-tools:~$
            oleg@mck-devops-tools:~$ ls -l
            total 12
            drwxrwxr-x  4 oleg oleg 4096 Feb 14 12:09 ansible
            drwxrwxr-x  4 oleg oleg 4096 Apr  7 14:15 devkub-homeworks
            drwxrwxr-x 15 oleg oleg 4096 Mar 28 16:30 kubespray
            oleg@mck-devops-tools:~$



3. Запуск приложений

    docker-compose up --build

Приложения запущены

    oleg@mck-devops-tools:~$ sudo docker ps
    CONTAINER ID   IMAGE                           COMMAND                  CREATED         STATUS         PORTS                                       NAMES
    ac4559879ef4   13-kubernetes-config_backend    "/bin/sh -c 'pipenv …"   4 minutes ago   Up 4 minutes   0.0.0.0:9000->9000/tcp, :::9000->9000/tcp   13-kubernetes-config_backend_1
    e8e2d60ab78f   13-kubernetes-config_frontend   "/docker-entrypoint.…"   4 minutes ago   Up 4 minutes   0.0.0.0:8000->80/tcp, :::8000->80/tcp       13-kubernetes-config_frontend_1
    01c42d9dc251   postgres:13-alpine              "docker-entrypoint.s…"   4 minutes ago   Up 4 minutes   5432/tcp                                    13-kubernetes-config_db_1
    oleg@mck-devops-tools:~$

4. Для frontend

        4.1 создал образ

                sudo docker commit ac4559879ef4 gitreg.migcredit.ru/orovenskij1/k8s-test/backend:v1
                
                oleg@mck-devops-tools:~$ sudo docker images
                REPOSITORY                                         TAG          IMAGE ID       CREATED          SIZE
                gitreg.migcredit.ru/orovenskij1/k8s-test/backend   v1           053230bce0b5   10 seconds ago   1.07GB

        4.2 пропушил его в регистри

                oleg@mck-devops-tools:~$ sudo docker push  gitreg.migcredit.ru/orovenskij1/k8s-test/backend:v1
                The push refers to repository [gitreg.migcredit.ru/orovenskij1/k8s-test/backend]
                d8cbe9dad8db: Pushed
                0a125ae29a51: Pushed
                4ea4136641dc: Pushed
                0a8f00de37eb: Pushed
                243a5dc891b7: Pushed
                4c9efc7d50b2: Pushed
                5fffd512537b: Pushed
                fef7b0285d08: Pushed
                dad95716bb70: Pushed
                627d03f17169: Pushed
                6b9b07bf46f5: Pushed
                88139fe969ab: Pushed
                83f556e4c108: Pushed
                7362f7f77851: Pushed
                v1: digest: sha256:c906929e487c500549a0eb1fa2a72525b81b28094516f52e03bf815f7073544d size: 3264
                oleg@mck-devops-tools:~$
                
               
               
        4.3 Проверил что он появился
          картинка
          
        4.4 Тоже самое для остальных  
          
                sudo docker commit e8e2d60ab78f gitreg.migcredit.ru/orovenskij1/k8s-test/frontend:v1
                sudo docker commit 01c42d9dc251 gitreg.migcredit.ru/orovenskij1/k8s-test/postgres:v1

                sudo docker push gitreg.migcredit.ru/orovenskij1/k8s-test/frontend:v1
                sudo docker push gitreg.migcredit.ru/orovenskij1/k8s-test/postgres:v1


5. Делаем аутентификацию k8s в регистри ГитЛаб согласно официальной документации

https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/

5.1
                root@mck-t-k8s-cp1:~# docker login  gitreg.migcredit.ru -u ORovenskij -p ejs7zH8qm8moyVU5X5c3
                WARNING! Using --password via the CLI is insecure. Use --password-stdin.
                WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
                Configure a credential helper to remove this warning. See
                https://docs.docker.com/engine/reference/commandline/login/#credentials-store

                Login Succeeded
                root@mck-t-k8s-cp1:~# ls -la

5.2 смотрим создался ли файл:

                root@mck-t-k8s-cp1:~#  cat ~/.docker/config.json
                {
                        "auths": {
                                "gitreg.migcredit.ru": {
                                        "auth": "T1JvdmVuc2tpajplanM3ekg4cW04bW95VlU1WDVjMw=="
                                }
                        }
                }root@mck-t-k8s-cp1:~#^C
                root@mck-t-k8s-cp1:~#

5.3 Создаём кредентиалс

                kubectl create secret generic regcred \
                    --from-file=.dockerconfigjson=/root/.docker/config.json \
                    --type=kubernetes.io/dockerconfigjson


                root@mck-t-k8s-cp1:~#
                root@mck-t-k8s-cp1:~# kubectl create secret generic regcred \
                >     --from-file=.dockerconfigjson=/root/.docker/config.json \
                >     --type=kubernetes.io/dockerconfigjson
                secret/regcred created
                root@mck-t-k8s-cp1:~#
                root@mck-t-k8s-cp1:~#
                root@mck-t-k8s-cp1:~# kubectl get secret regcred -o yaml
                apiVersion: v1
                data:
                  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSJnaXRyZWcubWlnY3JlZGl0LnJ1IjogewoJCQkiYXV0aCI6ICJUMUp2ZG1WdWMydHBhanBsYW5NM2VrZzRjVzA0Ylc5NVZsVTFXRFZqTXc9PSIKCQl9Cgl9Cn0=
                kind: Secret
                metadata:
                  creationTimestamp: "2022-04-07T20:03:08Z"
                  name: regcred
                  namespace: default
                  resourceVersion: "412007"
                  uid: a6acca05-9642-4906-be83-1ee21f49204d
                type: kubernetes.io/dockerconfigjson
                root@mck-t-k8s-cp1:~#


5.4 Можем проверить что все команды применились

                root@mck-t-k8s-cp1:~# kubectl get secret regcred --output="jsonpath={.data.\.dockerconfigjson}" | base64 --decode
                {
                        "auths": {
                                "gitreg.migcredit.ru": {
                                        "auth": "T1JvdmVuc2tpajplanM3ekg4cW04bW95VlU1WDVjMw=="
                                }
                        }
                }root@mck-t-k8s-cp1:~# echo "T1JvdmVuc2tpajplanM3ekg4cW04bW95VlU1WDVjMw==" | base64 --decode
                ORovenskij:ejs7zH8qm8moyVU5X5c3root@mck-t-k8s-cp1:~#
                root@mck-t-k8s-cp1:~#

5.5 Делаем тестовое развёртывание пода

Для этого:

5.6.1. Создаём тестовый манифест

                root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# cat test-connect-gitlab.yaml
                apiVersion: v1
                kind: Pod
                metadata:
                  name: frontend
                spec:
                  containers:
                  - name: frontend
                    image: gitreg.migcredit.ru/orovenskij1/k8s-test/frontend:v1
                  imagePullSecrets:
                  - name: regcred

5.6.2. root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# kubectl apply -f ./test-connect-gitlab.yaml
5.6.3.

                root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# kubectl get pods
                NAME       READY   STATUS    RESTARTS   AGE
                frontend   2/2     Running   0          2m4s

6. Под создался и запущеню.

Подготовительная часть для Домашней работы завершена.



## Основная часть

### Задание 1

Манифест для запуска пода с фронтенд и бекенд

              # cat fr-bk.yaml
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                labels:
                  app: hw13-1-task1
                name: hw13-1-task1
                namespace: default
              spec:
                replicas: 3
                selector:
                  matchLabels:
                    app: hw13-1-task1
                template:
                   metadata:
                     labels:
                       app: hw13-1-task1
                   spec:
                     containers:
                       - image: gitreg.migcredit.ru/orovenskij1/k8s-test/frontend:v1
                         name: frontend
                       - image: gitreg.migcredit.ru/orovenskij1/k8s-test/backend:v1
                         name: backend
                     imagePullSecrets:
                       - name: regcred


 
 Под и деплоймент запустились
 
               kubectl apply -f ./fr-bk.yaml
 
              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# kubectl get deployments
              NAME             READY   UP-TO-DATE   AVAILABLE   AGE
              hw13-1-task1     3/3     3            3           3m50s


              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# kubectl get pods
              NAME                              READY   STATUS    RESTARTS   AGE
              hw13-1-task1-7d5878d5f-cjbbt      3/3     Running   0          4m48s
              hw13-1-task1-7d5878d5f-hlt4d      3/3     Running   0          4m48s
              hw13-1-task1-7d5878d5f-p2dmx      3/3     Running   0          4m48s
 
 Манифест для запуска Базы Данных
 
              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# cat database.yaml
              apiVersion: apps/v1
              kind: StatefulSet
              metadata:
                name: database
                namespace: default
                labels:
                  k8s-app: database
              spec:
                serviceName: "database"
                replicas: 1
                selector:
                  matchLabels:
                    k8s-app: database
                template:
                  metadata:
                    labels:
                      k8s-app: database
                  spec:
                    containers:
                      - name: database
                        image: postgres:13-alpine
                        env:
                        - name: POSTGRES_PASSWORD
                          value: "postgres"
                        - name: POSTGRES_USER
                          value: "postgres"
                        - name: POSTGRES_DB
                          value: "news"


Запуск 

              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# kubectl apply -f ./database.yaml
              statefulset.apps/database created

              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config# kubectl get pods
              NAME                              READY   STATUS    RESTARTS   AGE
              database-0                        2/2     Running   0          2m


### Задание 3

1. Разделяем деплойментс для фронтенд и бекенд
2. Добавляем сервис
3. Добавляем окружение


Ддя фронтенда


              apiVersion: apps/v1
              kind: Deployment
              metadata:
                labels:
                  app: frontend
                name: frontend
                namespace: default
              spec:
                replicas: 3
                selector:
                  matchLabels:
                    app: frontend
                template:
                   metadata:
                     labels:
                       app: frontend
                   spec:
                     containers:
                       - image: gitreg.migcredit.ru/orovenskij1/k8s-test/frontend:v1
                         name: frontend
                         env:
                         - name: BACKEND_URL
                           value: backend:9000
                     imagePullSecrets:
                       - name: regcred
              ---

              apiVersion: v1
              kind: Service
              metadata:
                name: frontend
                namespace: default
              spec:
                ports:
                  - name: web
                    port: 8000
                    targetPort: 80
                    nodePort: 32756 
                selector:
                  app: frontend
                type: NodePort


Ддя бекенда

              apiVersion: apps/v1
              kind: Deployment
              metadata:
                labels:
                  app: backend
                name: backend
                namespace: default
              spec:
                replicas: 3
                selector:
                  matchLabels:
                    app: backend
                template:
                   metadata:
                     labels:
                       app: backend
                   spec:
                     containers:
                       - image: gitreg.migcredit.ru/orovenskij1/k8s-test/backend:v1
                         name: backend
                         env:
                         - name: DATABASE_URL
                           value: backend:5432
                     imagePullSecrets:
                       - name: regcred
              ---

              apiVersion: v1
              kind: Service
              metadata:
                name: backend
                namespace: default
              spec:
                ports:
                  - name: backend
                    port: 9000
                    nodePort: 32757 
                selector:
                  app: backend
                type: NodePort

и база данных

              apiVersion: apps/v1
              kind: StatefulSet
              metadata:
                name: database
                namespace: default
                labels:
                  k8s-app: database
              spec:
                serviceName: "database"
                replicas: 1
                selector:
                  matchLabels:
                    k8s-app: database
                template:
                  metadata:
                    labels:
                      k8s-app: database
                  spec:
                    containers:
                      - name: database
                        image: postgres:13-alpine
                        env:
                        - name: POSTGRES_PASSWORD
                          value: "postgres"
                        - name: POSTGRES_USER
                          value: "postgres"
                        - name: POSTGRES_DB
                          value: "news"

              ---

              apiVersion: v1
              kind: Service
              metadata:
                name: database
                namespace: default
              spec:
                ports:
                  - name: database
                    port: 5432
                selector:
                  app: database
                type: ClusterIP

Проверка

              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config/task2# kubectl get services
              NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
              backend       NodePort    10.233.54.118   <none>        9000:32757/TCP   6m5s
              database      ClusterIP   10.233.23.56    <none>        5432/TCP         5m42s
              frontend      NodePort    10.233.49.95    <none>        8000:32756/TCP   6m38s
              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config/task2#

       
              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config/task2# kubectl get pods
              NAME                              READY   STATUS    RESTARTS   AGE
              backend-76f48cc84f-mlgp4          2/2     Running   0          7m4s
              backend-76f48cc84f-pgrtj          2/2     Running   0          7m4s
              backend-76f48cc84f-rt4bx          2/2     Running   0          7m4s
              database-0                        2/2     Running   0          6m18s
              frontend-7969c75fcf-2nmkv         2/2     Running   0          7m14s
              frontend-7969c75fcf-l4sdh         2/2     Running   0          7m14s
              frontend-7969c75fcf-z559n         2/2     Running   0          7m14s
              root@mck-t-k8s-cp1:~/test-k8s-oleg/devkub-homeworks/13-kubernetes-config/task2#



